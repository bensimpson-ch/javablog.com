@if (loading()) {
  <div class="loading">Loading post...</div>
}

@if (error()) {
  <div class="error">{{ error() }}</div>
}

@if (post(); as post) {
  <article>
    <header>
      <div class="post-header">
        <h1>{{ post.title }}</h1>
        @if (authService.isAuthenticated) {
          <div class="post-controls">
            <a [routerLink]="['/author/posts', post.id, 'edit']" class="btn-icon" title="Edit">
              <i class="fa-solid fa-pen" aria-hidden="true"></i>
            </a>
            <button
              (click)="confirmDelete()"
              class="btn-icon btn-danger"
              [disabled]="deleting()"
              title="Delete"
            >
              <i class="fa-solid fa-trash" aria-hidden="true"></i>
            </button>
          </div>
        }
      </div>
      <time [attr.datetime]="getDateOnly(post.createdAt)">{{ formatDate(post.createdAt) }}</time>
    </header>

    <section [innerHTML]="post.content"></section>
  </article>

  <section class="comments-section">
    <h2>Comments</h2>

    <form class="comment-form" (ngSubmit)="submitComment()">
      <p class="comment-guidelines">
        Comments are for feedback on this specific post. For general questions, please use
        <a href="https://stackoverflow.com" target="_blank" rel="noopener">Stack Overflow</a>.
        Comments may be removed after one year.
      </p>

      <div class="form-group">
        <label for="author">Your Name</label>
        <input
          type="text"
          id="author"
          [(ngModel)]="commentAuthor"
          name="author"
          required
          maxlength="100"
          placeholder="Enter your name"
        >
      </div>

      <div class="form-group">
        <label for="content">Comment</label>
        <textarea
          id="content"
          [(ngModel)]="commentContent"
          name="content"
          required
          rows="4"
          placeholder="Share your thoughts or feedback..."
        ></textarea>
      </div>

      <button
        type="submit"
        class="btn btn-primary"
        [disabled]="submittingComment() || !commentAuthor.trim() || !commentContent.trim()"
      >
        @if (submittingComment()) {
          Submitting...
        } @else {
          Submit Comment
        }
      </button>
    </form>

    @if (comments().length > 0) {
      <div class="comments-list">
        @for (comment of comments(); track comment.id) {
          <div class="comment">
            <div class="comment-header">
              <div class="comment-meta">
                <strong class="comment-author">{{ comment.author }}</strong>
                <time [attr.datetime]="getDateOnly(comment.createdAt)">{{ formatDate(comment.createdAt) }}</time>
              </div>
              @if (authService.isAuthenticated) {
                <button
                  (click)="confirmDeleteComment(comment)"
                  class="btn-icon btn-danger btn-sm"
                  [disabled]="deletingComment() === comment.id"
                  title="Delete comment"
                >
                  <i class="fa-solid fa-trash" aria-hidden="true"></i>
                </button>
              }
            </div>
            <div class="comment-content">{{ comment.content }}</div>
          </div>
        }
      </div>
    } @else {
      <p class="no-comments">No comments yet. Be the first to share your thoughts!</p>
    }
  </section>

  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "BlogPosting",
      "headline": "{{ post.title }}",
      "datePublished": "{{ getDateOnly(post.createdAt) }}",
      "author": { "@type": "Person", "name": "Ben Simpson" }
    }
  </script>
}

@if (lightboxImage()) {
  <div class="lightbox" (click)="closeLightbox()">
    <img [src]="lightboxImage()" alt="Enlarged view">
  </div>
}
