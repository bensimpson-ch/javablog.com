<mat-card>
  <mat-card-header>
    <div class="header-row">
      <div>
        <mat-card-title>{{ isEditMode ? 'Edit Post' : 'Create New Post' }}</mat-card-title>
        <mat-card-subtitle>Author: Ben Simpson &lt;ben&#64;javablog.com&gt;</mat-card-subtitle>
      </div>
      <button mat-raised-button type="button" (click)="cancel()">&larr; Cancel</button>
    </div>
  </mat-card-header>

  <mat-card-content>
    @if (loading()) {
      <div class="loading">
        <mat-spinner diameter="40"></mat-spinner>
        <span>Loading post...</span>
      </div>
    } @else {
      <form [formGroup]="form" (ngSubmit)="submit()">
        <mat-form-field appearance="outline">
          <mat-label>Title</mat-label>
          <input matInput formControlName="title" (blur)="generateSlug()">
          @if (form.get('title')?.hasError('required')) {
            <mat-error>Title is required</mat-error>
          }
          @if (form.get('title')?.hasError('maxlength')) {
            <mat-error>Title must be 200 characters or less</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Language</mat-label>
          <mat-select formControlName="language">
            @for (lang of languages; track lang) {
              <mat-option [value]="lang">{{ languageLabels[lang] }}</mat-option>
            }
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Slug</mat-label>
          <input matInput formControlName="slug">
          <mat-hint>URL-friendly identifier{{ isEditMode ? '' : ' (auto-generated from title)' }}</mat-hint>
          @if (form.get('slug')?.hasError('required')) {
            <mat-error>Slug is required</mat-error>
          }
          @if (form.get('slug')?.hasError('pattern')) {
            <mat-error>Slug can only contain lowercase letters, numbers, and hyphens</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Summary</mat-label>
          <textarea matInput formControlName="summary" rows="3"></textarea>
          <mat-hint>Short description shown on the home page (max 500 characters)</mat-hint>
          @if (form.get('summary')?.hasError('required')) {
            <mat-error>Summary is required</mat-error>
          }
          @if (form.get('summary')?.hasError('maxlength')) {
            <mat-error>Summary must be 500 characters or less</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Content (HTML)</mat-label>
          <textarea matInput formControlName="content" rows="20"></textarea>
          @if (form.get('content')?.hasError('required')) {
            <mat-error>Content is required</mat-error>
          }
        </mat-form-field>

        <div class="actions">
          <button mat-raised-button color="primary" type="submit"
                  [disabled]="form.invalid || submitting() || (isEditMode && !form.dirty && !hasTranslationChanges())">
            @if (submitting()) {
              <mat-spinner diameter="20"></mat-spinner>
            } @else {
              {{ isEditMode ? 'Update Post' : 'Create Post' }}
            }
          </button>
          @if (!isEditMode && hasDraft()) {
            <button mat-button type="button" (click)="clearDraft()">Clear Draft</button>
          }
        </div>
      </form>

      @if (isEditMode) {
        <section class="translation-section">
          <h3>Request Translation</h3>
          <mat-checkbox
            [checked]="translateAll()"
            (change)="toggleAllLanguages($event.checked)">
            Translate all languages
          </mat-checkbox>
          <mat-accordion>
            <mat-expansion-panel>
              <mat-expansion-panel-header>
                <mat-panel-title>Select individual languages</mat-panel-title>
              </mat-expansion-panel-header>
              <div class="language-grid">
                @for (lang of translationLanguages(); track lang) {
                  <mat-checkbox
                    [checked]="translateAll() || selectedLanguages().has(lang)"
                    (change)="toggleLanguage(lang)">
                    {{ languageLabels[lang] }}
                  </mat-checkbox>
                }
              </div>
            </mat-expansion-panel>
          </mat-accordion>
        </section>
      }
    }
  </mat-card-content>
</mat-card>
